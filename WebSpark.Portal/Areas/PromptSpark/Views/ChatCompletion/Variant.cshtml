@model DefinitionDto
@{
    var encodedName = System.Text.Encodings.Web.HtmlEncoder.Default.Encode(Model.Name);
    var encodedDescription = System.Text.Encodings.Web.HtmlEncoder.Default.Encode(Model.Description);
    ViewData["Title"] = $"Interactive Chat with AI - {encodedName}";
    ViewData["Description"] = $"Experience an interactive chat interface with {encodedName} powered by AI. Discover how PromptSpark enhances communication with advanced SignalR integration and seamless user interactions.";
    ViewData["Keywords"] = $"PromptSpark, AI Chat, SignalR, Interactive Chat,Chat Completions, .Net 9, Bootstrap 5, AI Communication,{encodedName}";
}

<div class="container-fluid vh-100 d-flex flex-column bg-dark text-light p-0">
    <div class="card bg-secondary text-light w-100 h-100" style="max-width: 1200px; max-height: 60vh;">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i> Chat with @Model.Name</h5>
        </div>

        <!-- Chat messages container -->
        <div class="card-body overflow-auto p-3 flex-grow-1" id="messagesContainer" style="height: 60vh;">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input section -->
        <div class="card-footer p-2 bg-dark">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control bg-secondary text-light border-0" placeholder="Type your message...">
                <button class="btn btn-success" id="sendButton">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.7/signalr.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.on("ReceiveMessage", (user, message) => {
            const messagesList = document.getElementById('receiveMessage');
            messagesList.innerHTML += `${message}`;

            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        connection.start().catch(err => console.error(err.toString()));

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (message) {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'userInput';
                userMessageDiv.textContent = message;

                const messagesList = document.getElementById('messagesContainer');
                messagesList.appendChild(userMessageDiv);

                const allMessages = [];
                const messageDivs = messagesList.getElementsByTagName('div');
                for (let i = 0; i < messageDivs.length; i++) {
                    allMessages.push(messageDivs[i].textContent);
                }

                document.getElementById('messageInput').value = '';

                const existingReceiveMessage = document.getElementById('receiveMessage');
                if (existingReceiveMessage) {
                    existingReceiveMessage.removeAttribute('id');
                }
                const newReceiveMessageDiv = document.createElement('div');
                newReceiveMessageDiv.id = 'receiveMessage';
                newReceiveMessageDiv.className = 'systemResponse';
                messagesList.appendChild(newReceiveMessageDiv);

                const formData = new FormData();
                formData.append('message', message);
                formData.append('conversationHistory', JSON.stringify(allMessages));
                fetch('/PromptSpark/ChatCompletion/SendMessage', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json())
                    .then(data => console.log(data))
                    .catch(err => console.error(err.toString()));
            }
        }

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        document.getElementById('messageInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
}
